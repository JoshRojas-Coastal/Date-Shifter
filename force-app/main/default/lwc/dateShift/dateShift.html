<template>
	<lightning-card icon-name="standard:event">
		<div slot="title">
			<strong><h2>Demo Date Shifter</h2></strong>
		</div>
		<template if:true={startingDateShift}>
			<lightning-spinner alternative-text="Starting date shift ..."></lightning-spinner>
		</template>
		<lightning-button-icon-stateful
			slot="actions"
			icon-name="utility:question"
			variant="neutral"
			selected={helpSectionVisible}
			onclick={handleHelpButton}
		></lightning-button-icon-stateful>
		<template if:false={shiftInProgress}>
			<c-date-shift-date-selector ondatefilterchange={handleDateFilterChange}></c-date-shift-date-selector>
			<template if:true={objectListIsEmpty}>
				<div class="slds-p-around_large">
					<p>
						<em>
							You do not have any active date shift objects. You can create new ones from the <strong>Date Shift Objects</strong> tab or you can activate existing ones so that
							they will appear in the list.
						</em>
					</p>
					<div class="slds-align_absolute-center slds-p-top_medium">
						<lightning-button label="Go to the Date Shift Object List" variant="brand-outline" onclick={handleDateShiftObjectClick}></lightning-button>
					</div>
				</div>
			</template>
			<template if:false={objectListIsEmpty}>
				<section class="slds-p-around_medium">
					<lightning-datatable columns={objectListColumns} data={objectList} key-field="itemId" hide-checkbox-column="true"></lightning-datatable>
					<div class="slds-p-around_medium slds-align_absolute-center">
						<lightning-button variant="destructive" label="Shift the Dates" disabled={dateFilterNotSet} onclick={handleShiftDatesButton}></lightning-button>
					</div>
				</section>
			</template>
		</template>
		<template if:true={shiftInProgress}>
			<div class="slds-p-horizontal_medium">
				<template if:false={dateShiftFinished}>
					<p class="slds-p-vertical_medium">
						All the <code>Date</code> and <code>DateTime</code> fields in the following objects are being shifted {forBack} by&nbsp;
						<span> <lightning-formatted-number value={minutesToShift}></lightning-formatted-number> minutes </span>
						<span> (<lightning-formatted-number value={daysToShift} maximum-fraction-digits="0"></lightning-formatted-number> days). </span> If you navigate away from this
						page or tab, the date shifting will continue, but you will not be able to monitor the progress.
					</p>
				</template>
				<template if:true={dateShiftFinished}>
					<p class="slds-p-vertical_medium">
						Date shifting is now complete. Make sure that you run any Einstein Analytics dataflows that contain the records you shifted so that your dashboards will reflect
						the shifted dates. If you have any questions about how to do that, please consult one of your team's Einstein Analytics Blackbelts.
					</p>
				</template>
				<table class="slds-table slds-table_cell-buffer slds-no-row-hover slds-p-vertical_x-large">
					<tbody>
						<template for:each={objectList} for:item="dso">
							<tr class="slds-p-vertical_medium" key={dso.itemAPIName}>
								<td class="runningObject">
									<lightning-formatted-text value={dso.itemLabelPlural} class="slds-truncate"></lightning-formatted-text>
								</td>
								<td class="runningProgressBar">
									<lightning-progress-bar size="large" value={dso.itemPercentage} title={dso.itemToolTip}></lightning-progress-bar>
								</td>
								<td class="runningRemaining">
									<template if:true={dso.itemShiftFinished}>
										<template if:true={dso.itemNumberOfErrors}>
											<strong><span class="slds-text-color_error">Done</span></strong>
										</template>
										<template if:false={dso.itemNumberOfErrors}>
											<strong><span class="slds-text-color_success">Done</span></strong>
										</template>
									</template>
									<template if:false={dso.itemShiftFinished}>
										<lightning-formatted-number value={dso.itemRemaining} class="slds-text-align--right"></lightning-formatted-number>
									</template>
								</td>
								<td class="runningErrors">
									<template if:true={dso.itemNumberOfErrors}>
										<span class="slds-text-color_error">
											<lightning-formatted-number value={dso.itemNumberOfErrors} class="slds-text-color_error"></lightning-formatted-number>&nbsp;error(s)
										</span>
									</template>
								</td>
							</tr>
						</template>
					</tbody>
				</table>
				<template if:true={dateShiftFinished}>
					<template if:true={dateShiftHadErrors}>
						<p class="slds-p-vertical_medium slds-text-color_error">
							The following errors occurred during the date shift. Only these records were affected and all others were shifted properly.
						</p>
						<div class="slds-scrollable scrollerSize">
							<lightning-datatable
								columns={errorListColumns}
								data={errorList}
								key-field="id"
								hide-checkbox-column="true"
							></lightning-datatable>
						</div>
					</template>
				</template>
			</div>
		</template>
		<template if:true={helpSectionVisible}>
			<section class="slds-p-horizontal_large">
				<lightning-tile class="slds-tile_board slds-box slds-theme_shade">
					<lightning-icon icon-name="utility:info" slot="media"></lightning-icon>
					<h2 class="slds-p-bottom_medium"><strong>Motivation</strong></h2>
					<p>
						This component was inspired by the Salesforce SDO/CDO Perfect Date Wizard, and includes some interesting enhancements. There was a desire to more fine-tune the
						date and time shifting beyond the date boundary and also to be able to shift dates backwards and forwards by arbitrary amounts. This would allow an SE to shift
						dates forward to the date and time of the actual demo instead of just today's date, and be able to shift them backwards if any anomalies resulted.
					</p>
					<h2 class="slds-p-vertical_medium"><strong>How It Works</strong></h2>
					<p>
						Setting up the objects whose <code>Date</code> and <code>DateTime</code> fields are to be shifted is easy: just navigate to the
						<strong>Date Shift Object</strong> tab and create as many records for objects as you need. Each one will require the API name of the object whose
						<code>Date</code> and <code>DateTime</code>fields you want to shift. Additionally, you can can check a box specifying whether to ensure that a date falls on a
						weekday when it's shifted (if the shifted date/time falls on a Saturday, it will be further adjusted to fall on the previous Friday; if it falls on a Sunday, it
						will be further adjusted to fall on the following Monday). This can be useful in demo scenarios in which, say, cases can come in any time during the week but
						calendar events are only scheduled with people on weekdays. To adjust the minutes as well as the date (useful for objects like Cases), check the the
						<strong>Adjust Minutes</strong> box; leave it unchecked so that <code>DateTime</code> fields in objects like calendar events that typically begin and end on hour
						or half-hour boundaries won't wind up with odd-looking times. Finally, you can use a checkbox to specify whether or not the object is active, in case you wanted to
						deactivate it temporarily without deleting the definition entirely.
					</p>
					<p class="slds-p-top_medium">
						For each object in the list, the component inspects the object's schema and gathers a list of all <code>Date</code> and <code>DateTime</code> fields that are
						updateable (certain audit fields such as <code>CreatedDate</code> cannot be modified for security reasons; also, the <code>Case</code> fields
						<code>SlaStartDate</code> and <code>SlaExitDate</code>
						will not be shifted to avoid errors concerning entitlements on closed cases).
					</p>
					<h2 class="slds-p-vertical_medium"><strong>Reference</strong></h2>
					<p>
						You can always find the latest version of this component in
						<lightning-formatted-url label="this GitHub repository" value="https://github.com/johnsfdemo/Demo-Shift-Dates"></lightning-formatted-url>.
					</p>
				</lightning-tile>
			</section>
		</template>
	</lightning-card>
</template>
